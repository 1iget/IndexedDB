<!DOCTYPE html>
<html lang='en-US'>
  <head>
    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
    <title>Indexed Database API</title>
    <meta name='revision' content='$Id: Overview.html,v 1.41 2010/03/24 17:58:17 nmehta3 Exp $'/>
    <script src='http://dev.w3.org/2009/dap/ReSpec.js/js/respec.js' class='remove'></script>
    <script src='http://dev.w3.org/2009/dap/ReSpec.js/js/simple-node.js' class='remove'></script>
    <script class='remove'>
      var respecConfig = {
          specStatus:           "ED",

          shortName:            "IndexedDB",

          //publishDate:          "2010-01-05",

          previousPublishDate:  "2010-01-05",
          previousMaturity:     "WD",

          edDraftURI:           "http://dev.w3.org/2006/webapi/WebSimpleDB/",

          // if this is a LCWD, uncomment and set the end of its review period
          // lcEnd: "2009-08-05",

          extraCSS: [
                "http://dev.w3.org/2009/dap/ReSpec.js/css/respec.css",
                "SimpleDB.css"
          ],

          // editors, add as many as you like
          // only "name" is required
          editors:  [
              { name: "Nikunj Mehta", url: "mailto:nikunj@o-micron.com",
                company: "Invited Expert" },
          ],

          maxTocLevel: 3,

          wg:           "Web Applications Working Group",

          wgURI:        "http://www.w3.org/2008/webapps/",

          wgPublicList: "public-webapps",

          wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/42538/status",
      };
    </script>
    <script class="remove">
      function examples() {
        var examples = document.querySelectorAll('div.example');
        sn = new berjon.simpleNode({
                        "":     "http://www.w3.org/1999/xhtml",
                        "x":    "http://www.w3.org/1999/xhtml"
                    });
        for (var i = 0; i < examples.length; i++) {
          var example = examples.item(i);
          var header = sn.element('div', {'class': 'exampleHeader'}, null, 'Example');
          example.insertBefore(header, example.firstChild);
        }
      }

      function codeblocks() {
        document.normalize();
        sn = new berjon.simpleNode({
                        "":     "http://www.w3.org/1999/xhtml",
                        "x":    "http://www.w3.org/1999/xhtml"
                    });

        var blocks = document.querySelectorAll('codeblock');
        for (var i = 0; i < blocks.length; i++) {
          var codeblock = blocks.item(i);
          var div = sn.element('div', {'class': 'block'})
          sn.element('span', {'class': 'blockTitle'},
            sn.element('div', {'class': 'blockTitleDiv'}, div), 'ECMAScript');
          var code = sn.element('code', {'class': 'es-code'},
                       sn.element('pre', {'class': 'code'},
                         sn.element('div', {'class': 'blockContent'}, div)));
          sn.copyChildren(codeblock, code);
          codeblock.parentNode.replaceChild(div, codeblock);
        }
      }
      window.onload = function() {
        examples();
        codeblocks();
        (new berjon.respec()).loadAndRun();
      }
    </script>
    <!--[if IE]>
    <style type='text/css'>
      .ignore {
        -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";
        filter: alpha(opacity=50);
      }
    </style>
    <![endif]-->
    <style type="text/css">
      table {
        border-collapse: collapse;
        border-style: hidden hidden none;
      }
      table thead {
        border-bottom: medium solid;
      }
      table td, table th {
        border-bottom: thin solid;
        border-left: medium solid;
        border-right: medium solid;
        padding: 0.2em;
        vertical-align: top;
      }
      h5 {
        display: none
      }
    </style>
  </head>

  <body>
    <section id="abstract">
      <p>
        This document defines APIs for a database of records holding simple values
        and hierarchical objects. Each record consists of a key and some value.
        Moreover, the database maintains indexes over records it stores. An
        application developer directly uses an API to locate records either by
        their key or by using an index. A query language can be layered on this
        API. An indexed database can be implemented using a persistent B-tree data
        structure.
      </p>
    </section>

    <section id="database-api" class="section">
      <h2>Indexed Database API</h2>


      <!-- begin-content -->
      <section class="section" id="algorithms">
        <h3>Algorithms</h3>
        <section class="section" id="opening">
          <h4>Opening the database</h4>
          <p>
            The <dfn>steps for opening a database</dfn> are as follows. The algorithm in these steps
            take three arguments. A <var>origin</var> which requested the <a>database</a> to be opened,
            a database <var>name</var>. It also optionally takes a <var>request</var> which represents
            a <a>request</a> used when opening the database is done using an asynchronous API.
          </p>
          
          <ol>
            <li>
              If these steps fail for any reason, return a error with the appropriate code and abort
              this algorithm.
            </li>
            <li>
              If there is already a database with the given name from the origin <var>origin</var>, then
              let <var>db</var> be that database.
            </li>
            <li>
              If no database with the given name from the origin <var>origin</var>
              exists, then create the database <var>db</var> with name <var>name</var>.
            </li>
            <li>
              Wait until no already existing <a>connection</a>s to <var>db</var>, have
              non-<a title="transaction finish">finished</a> VERSION_CHANGE <a>transaction</a>s.
              <p class="note">
                There can potentially be several <a>connection</a>s waiting for a VERSION_CHANGE transaction
                to finish. Once that transaction <a title="transaction finish">finishes</a> another <a>connection</a>
                could be created and a new VERSION_CHANGE transaction could be started before these steps has
                a chance to continue. In that case the implementation MUST keep waiting at this step.
              </p>
            </li>
            <li>
              Create a <a>connection</a> to <var>db</var> and return it.
            </li>
          </ol>        
        </section>
        
        <section class="section">
          <h4>Object Store Storage steps</h4>
          <p>
            The <dfn>steps for storing a record into an object store</dfn> are as follows. 
            These steps MUST be run with four parameters: the <a>object store</a>,
            a value, an optional key, and an optional no-overwrite flag.
          </p>
          <ol>
            <li>
              Let <var>store</var> be the <a>object store</a>, <var>key</var> be
              the key and <var>value</var> be the value passed to these steps.
            </li>
            <li>
              If <var>store</var> uses <a>out-of-line keys</a> but no <a>key 
              generator</a>, then a key MUST be passed to these steps. If not, 
              terminate these steps and set error code <a class="idlType" href="#widl-IDBDatabaseException-DATA_ERR"><code>DATA_ERR</code></a>.
            </li>
            <li>
              If <var>store</var> uses <a>in-line keys</a>, then 
              let <var>key</var> be the property of <var>object</var> at  
              <var>store</var>'s <a title="object store key path">key path</a>.
            </li>
           <li>
              Produce a <a>structured clone</a> of <var>value</var> and call it
              <var>object</var>.
            </li>
            <li>
              If <var>key</var> is not defined or null, then perform the 
              following steps.
              <ol>
                <li>
                  If <var>store</var> does not have a <a>key generator</a>, then 
                  terminate these steps and set error code <a class="idlType" href="#widl-IDBDatabaseException-NOT_ALLOWED_ERR"><code>NOT_ALLOWED_ERR</code></a>.
                </li>
                <li>
                  Using <var>store</var>'s <a>key generator</a>, produce the 
                  next key and store it as <var>key</var>.
                </li>
                <li>
                  If <var>store</var> uses <a>in-line keys</a>, then store 
                  <var>key</var> as the property value for <var>object</var> at  
                  <var>store</var>'s <a title="object store key path">key path</a>.
                </li>
              </ol>
            </li>
            <li>
              If the no-overwrite flag was passed to these steps and is set, and 
              a record already exists with its key being <var>key</var>, then 
              terminate these steps and set error code <a class="idlType" href="#widl-IDBDatabaseException-CONSTRAINT_ERR"><code>CONSTRAINT_ERR</code></a>.
            </li>
            <li>
              <p>
                Store a record in <var>store</var> containing <var>key</var> as its key  
                and <var>object</var> as its value. If any <a title="index">indexes</a>  
                are <a>auto-populated</a> for <var>store</var>, then store a record
                in that index according to <a>index maintenance conditions</a>.
              </p>
              <div class="note">
                Storing would mean inserting if no record exists for that key
                or updating an existing record, otherwise. <a title="auto-populated">
                Auto populated</a> <a>index</a> record will also be respectively
                inserted or updated depending on what storing results in.
              </div>
            </li>
            
            <li>
              Return the <var>key</var>.
            </li>
          </ol>
        </section>
        
        <section class="section">
          <h4>Object Store Retrieval steps</h4>
          <p>
            The <dfn>steps for retrieving a record from an object store</dfn> are
            as follows. These steps MUST be run with two parameters - the record 
            key and the <a>object store</a>.
          </p>
            
          <ol>
            <li>
              Let <var>key</var> be the key and <var>store</var> be the <a>object
              store</a> passed to these steps.
            </li>
            <li>
              If no record exists with key <var>key</var> in <var>store</var>,
              then terminate these steps and set error code
              <a class="idlType" href="#widl-IDBDatabaseException-NOT_FOUND_ERR"><code>NOT_FOUND_ERR</code></a>.
            </li>
            <li>
              Return the a new <a>structured clone</a> of the value in the record with 
              key <var>key</var> in <var>store</var>.
            </li>
          </ol>
        </section>
        
        <section class="section">
          <h4>Index Referenced Value Retrieval steps</h4>
          <p>
            The <dfn>steps for retrieving a record from an index</dfn> are
            as follows. These steps MUST be run with two parameters - the record 
            key and the <a>index</a>.
          </p>
            
          <ol>
            <li>
              Let <var>key</var> be the key and <var>index</var> be the <a>index</a>
              passed to these steps.
            </li>
            <li>
              If no record exists with key <var>key</var> in <var>index</var>,
              then terminate these steps and set error code
              <a class="idlType" href="#widl-IDBDatabaseException-NOT_FOUND_ERR"><code>NOT_FOUND_ERR</code></a>.
            </li>
            <li>
              Let <var>value</var> be the value of the record with key <var>key</var>
              in <var>index</var>.
            </li>
            <li>
              Return the value for the record with key <var>value</var> in 
              <var>index</var>'s <a>referenced</a> <a>object store</a>.
            </li>
          </ol>
        </section>
        
        <Section class="section">
          <h4>Index Value Retrieval steps</h4>
          <p>
            The <dfn>steps for retrieving a value from an index</dfn> are
            as follows. These steps MUST be run with two parameters - the record 
            key and the <a>index</a>.
          </p>
            
          <ol>
            <li>
              Let <var>key</var> be the key and <var>index</var> be the <a>index</a>
              passed to these steps.
            </li>
            <li>
              If no record exists with key <var>key</var> in <var>index</var>,
              then terminate these steps and set error code
              <a class="idlType" href="#widl-IDBDatabaseException-NOT_FOUND_ERR"><code>NOT_FOUND_ERR</code></a>.
            </li>
            <li>
              Return the value of the record with key <var>key</var>
              in <var>index</var>.
            </li>
          </ol>
        </section>
        
        <section class="section">
          <h4>Object Store Deletion steps</h4>
          <p>
            The <dfn>steps for deleting a record from an object store</dfn> 
            are as follows. These steps MUST be run with two parameters: the key
            of the record to be deleted and the <a>object store</a>.
          </p>
          <ol>
            <li>
              Let <var>key</var> be the key and <var>store</var> be the <a>object
              store</a> passed to these steps.
            </li>
            <li>
              If no record exists with key <var>key</var> in <var>store</var>,
              then terminate these steps and set error code
              <a class="idlType" href="#widl-IDBDatabaseException-NOT_FOUND_ERR"><code>NOT_FOUND_ERR</code></a>.
            </li>            
            <li>
               If any <a title="index">indexes</a> are <a>auto-populated</a> for
               <var>store</var>, then remove the record in that index according 
               to <a>index maintenance conditions</a>.
            </li>
            
            <li>
              Remove the record from <var>store</var> with key <var>key</var>. 
            </li>
          </ol>
        </section>
        <section class="section">
          <h4>Index Deletion steps</h4>
          <p>
            The <dfn>steps for deleting a record from an index</dfn> 
            are as follows. These steps MUST be run with two parameters: the key
            of the record to be deleted and the <a>index</a>.
          </p>
          <ol>
            <li>
              Let <var>key</var> be the key and <var>index</var> be the <a>index</a>
              passed to these steps.
            </li>
            <li>
              If no record exists with key <var>key</var> in <var>index</var>,
              then terminate these steps and set error code
              <a class="idlType" href="#widl-IDBDatabaseException-NOT_FOUND_ERR"><code>NOT_FOUND_ERR</code></a>.
            </li>            
            <li>
              Remove the records from <var>index</var> with key <var>key</var>. 
            </li>
          </ol>
        </section>
        <section class="section">
          <h4>Transaction Creation steps</h4>
          <p>
            When the user agent is to <dfn>create a static <a>transaction</a></dfn>
            it MUST run the following steps. This algorithm takes four parameters:
            A <a><var>connection</var></a>, a <a><var>mode</var></a>, a list of <var>names</var> of
            <a>object store</a>s to be included in the <a>scope</a> of the transaction, and a
            <var>timeout</var> for the transaction <a title="transaction start">starting</a>.
          </p>
          
          <ol>
            <li>
              If any of the strings in <var>names</var> identifies an <a>object store</a> which doesn't
              exist, throw a NOT_FOUND_ERR exception. If the <a>closePending</a>
              flag is set on <var>connection</var> the throw a NOT_ALLOWED_ERR.
            </li>
            <li>
              <a title="transaction create">Create</a> a <a>transaction</a> using <var>connection</var> as
              <a>connection</a>, <var>mode</var> as <a>mode</a>, and the <a>object store</a>s identified in
              <var>names</var> as <a>scope</a>.
            </li>
            <li>
              If these steps are running asynchronously, return the created <a>transaction</a> and run the
              remaining steps asynchronously. When control is returned to the event loop, the implementation
              MUST set the <a>active</a> flag to false.
            </li>
            <li>
              Wait until the <a>transaction</a> can be <a title="transaction start">started</a> according to the
              <a>transaction lifetime</a> rules. If this takes longer than the specified <var>timeout</var> then:
              <ul>
                <li>
                  If these steps are run asynchronously, run the <a>steps for aborting a transaction</a> using
                  TIMEOUT_ERR as <var>code</var>.
                </li>
                <li>
                  If steps are run synchronously, throw a TIMEOUT_ERR exception.
                </li>
              </ul>
            </li>
            <li>
              If these steps are running synchronously, return the created <a>transaction</a>.
            </li>
          </ol>
          <div class="issue">
            <p>Add steps for creating dynamic transactions.</p>
          </div>     
        </section>
        <section class="section">
          <h4>Steps for aborting a transaction</h4>
          <p>
            When taking the <dfn>steps for aborting a <a>transaction</a></dfn> the implementation MUST
            execute the following algorithm. This algorithm takes two parameter, the <var>transaction</var> to abort
            and a <var>code</var>.
          </p>
          <ol>
            <li>
              All the changes made to the <a>database</a> the transaction uses are reverted. For VERSION_CHANGE
              transactions this includes changes to the set of <a>object store</a>s and <a>index</a>es, as well
              as the change to the <a>version</a>.
            </li>
            <li>
              If the transaction's <a>request list</a> contain any <a>request</a>s whose <a title="request done">done</a> flag
              is still false, <a>fire a error event</a> with code <var>code</code> against each such <a>request</a>
              and set its <a title="request done">done</a> flag to true. Also abort the <a>steps for asynchronously
              executing a request</a> for each such transaction.
            </li>
          </ol>
        </section>
        <section class="section">
          <h4>Steps for asynchronously executing a <a>request</a></h4>
          <p>
            When taking the <dfn>steps to a asynchronously execute a request</dfn> the implementation MUST run the
            following algorithm. The algorithm takes a <var>source</var> object and a <var>operation</var> to
            perform on a database.
          </p>
          <p>
            These steps can be aborted at any point if the <a>transaction</a> the created <a>request</a> belongs
            to is <a title="transaction abort">aborted</a> using the <a>steps for aborting a transaction</a>
          </p>
          <ol>
            <li>
              Set <var>transaction</var> to the <a>transaction</a> associated with <var>source</var>.
            </li>
            <li>
              Create a <a>IDBRequest</a> object and set <var>request</var> to this object. Set <var>request</var>'s
              <a title="request source">source</a> to <var>source</var> and add <var>request</var> to the end of the
              <a title="request list">list</a> of <a>request</a>s in <var>transaction</var>. Return
              this object and run the remaining steps in this algorithm asynchronously.
              <p class="note">
                Cursors override this step to reuse an existing <a>IDBRequest</a>. However they still put the
                <a>IDBRequest</a> at the end of the list of <a>request</a>s in <var>transaction</var>.
              </p>
            </li>
            <li>
              Wait until all previously added <a>requests<a> in <var>transaction</var> have their
              <a title="request done">done</a> flag set to true.
            </li>
            <li>
              Perform <var>operation</var>.
            </li>
            <li>
              If performing <var>operation</var> succeeded then set the <a title="request done">done</a> flag
              on the <var>request</var> to true and <a>fire a success event</a> at <var>request</var> with
              the result of the operation.
            </li>
            <li>
              If performing <var>operation</var> failed then set the <a title="request done">done</a> flag
              on the <var>request</var> to true and <a>fire a error event</a> at <var>request</var> with
              the code of the error from <var>operation</var>.
            </li>
          </ol>
        </section>
        <section class="section">
          <h4>Steps for synchronously executing a <a>request</a></h4>
          <p>
            When taking the <dfn>steps to a synchronously execute a request</dfn> the implementation MUST run the
            following algorithm. The algorithm takes a <var>transaction</var> object and a <var>operation</var> to
            perform on a database.
          </p>
          <ol>
            <li>
              Perform <var>operation</var>.
            </li>
            <li>
              If performing <var>operation</var> succeeded then set return the result of the operation.
            </li>
            <li>
              If performing <var>operation</var> failed then throw a IDBDatabaseException with the code
              of the error from <var>operation</var>.
            </li>
          </ol>
        </section>
        <section class="section">
          <h4>VERSION_CHANGE transaction steps</h4>
          <p>
            The <dfn>steps for running a <code>VERSION_CHANGE</code> transaction</dfn> are
            as follows. This algorithm takes two parameters - a <var>connection</var> object which is used
            to update the <a>database</a> and a new <var>version number</var> to be set for the <a>database</a>.
          </p>
          <ol>
            <li>
              Create a new <a>transaction</a> with <a>mode</a> set to VERSION_CHANGE and <var>connection</var> used as <a>connection</a>.
              The <a>scope</a> of the transaction includes every <a>object store</a> in <var>connection</var>. Set its
              <a>active</a> flag to false.
            </li>
            <li>
              Create a new <a>request</a> which uses the <a>IDBVersionChangeRequest</a> interface and return it.
              The remaining steps in this algorithm are run asynchronously.
            </li>
            <li>
              Let <var>openDatabases</var> be the set of all <a><code>IDBDatabase</code></a> and <a><code>IDBDatabaseSync</code></a>
              objects, except <var>connection</var>, connected to the same <a>database</a> as <var>connection</var>.
            </li>
            <li>
              <p>
                Fire a <code>versionchange</code> event at each object in <var>openDatabases</var> that is open. The event MUST NOT
                be fired on objects which has the <code>closePending</code> flag set. The event MUST use the
                <a><code>IDBVersionChangeEvent</code></a> interface and have the
                <a href="#widl-IDBVersionChangeEvent-version"><code>version</code></a> property set to <var>version number</var>.
                This event MUST NOT bubble or be cancelable.
              </p>
              <p class="note">
                Firing this event might cause one or more of the other objects in <var>openDatabases</var> to be closed, in which case
                the <code>versionchange</code> event MUST NOT be fired at those objects if that hasn't yet been done.
              </p>
            </li>
            <li>
              <p>
                If any of the <a>connection</a>s in <var>openDatabases</var> are still not closed, fire a <code>blocked</code> event at
                <var>request</var>. The event MUST use the <a><code>IDBVersionChangeEvent</code></a> interface and have the
                <a href="#widl-IDBVersionChangeEvent-version"><code>version</code></a> property set to <var>version number</var>.
                This event MUST NOT bubble or be cancelable.
              </p>
            </li>
            <li>
              Wait until all objects in <var>openDatabases</var> are <a title="database close">closed</a> and all of
              their transactions are <a title="transaction finish">finished</a>.
              <p class="issue">Should we allow <code>blocked</code> to be fired here too, if waiting takes "too long"?</p>.
            </li>
            <li>
              Start a the <a>transaction</a> created above. Note that until this <a>transaction</a> is finished, no other <a>connection</a>s
              can be opened to the same <a>database</a>.
            </li>
            <li>
              Set the version of <var>database</var> to the given <var>version number</var>. This change is considered part of the
              <a><code>transaction</code></a>, and so if the transaction is <a>abort</a>ed, this change is reverted.
            </li>
            <li>
              Fire a <a><code>success</code></a> event targeted at the <var>request</var> object. The <a><code>result</code></a>
              propety of the event should be set to a new <a><code>IDBTransaction</code></a> object representing the
              <a><code>VERSION_CHANGE</code></a> transaction created in step 4.
            </li>
            <li>
              Follow the normal steps for executing a <a><code>transaction</code></a> and let the <a><code>transaction</code></a>
              finish normally.
            </li>
          </ol>
        </section>
        <section class="section">
          <h4>Database closing steps</h4>
          <p>The <dfn>steps for closing a database connection</dfn> are as follows. These steps take one argument, a <var>connection</var> object.
          <ol>
            <li>
              Set the internal <a><code>closePending</code></a> flag of <var>connection</var> to true.
            </li>
            <li>
              Wait for all transactions <a title="transaction create">created</a> using <var>connection</var> to complete.
              Once they are complete, <var>connection</var> is <dfn title="database close">closed</dfn>.
            </li>
          </ol>
          <p class="note">
            Once the <a><code>closePending</code></a> flag has ben set to true no new transactions can be
            <a title="transaction create">created</a> using <var>connection</var>. All functions that
            <a title="transaction create">create</a> transactions first check the the <a>closePending</a> flag first and
            throw an exception if it is true.
          </p>
        </section>
        <section class="section">
          <h4>Fire a success event</h4>
          <p>
            To <dfn title="fire a success event">fire a success event with result <var>result</var></dfn> at a <a>request</a>,
            the implementation MUST run the following steps:
          </p>
          <ol>
            <li>
              Set <var>transaction</var> to the <a>transaction</a> associated with the <a title="request source">source</a>.
            </li>
            <li>
              Set the <a>active</a> flag of <var>transaction</var> to true.
            </li>
            <li>
              Dispatch a <a title="event-success">success event</a>, which does not bubble and is not
              cancelable, at <a>request</a>. The event must use the <a><code>IDBSuccessEvent</code></a> interface and have its 
              <a class="idlType" href="#widl-IDBSuccessEvent-result"><code>result</code></a> set to <var>result</var>. The
              <a class="idlType" href="#widl-IDBEvent-source"><code>source</code></a> is set to <var>request</var>s
              <a title="request source">source</a>. And <a class="idlType" href="#widl-IDBTransactionEvent-result"><code>transaction</code></a>
              is set to <var>transaction</var>.
            </li>
            <li>
              Set the <a>active</a> flag of <var>transaction</var> to false.
            </li>
          </ol>
        </section>
        <section class="section">
          <h4>Fire an error event</h4>
          <p>
            To <dfn title="fire a error event">fire a error event with code <var>code</var></dfn> at a <a>request</a>,
            the implementation MUST run the following steps:
          </p>
          <ol>
            <li>
              Set <var>transaction</var> to the <a>transaction</a> associated with the <a title="request source">source</a>.
            </li>
            <li>
              Set the <a>active</a> flag of <var>transaction</var> to true.
            </li>
            <li>
              Dispatch a <a title="event-error">error event</a> at <a>request</a>. The event must use
              the <a><code>IDBErrorEvent</code></a> interface and have its 
              <a class="idlType" href="#widl-IDBErrorEvent-code"><code>code</code></a> set to <var>code</var>. The
              <a class="idlType" href="#widl-IDBEvent-source"><code>source</code></a> is set to <var>request</var>s internal
              <a title="request source">source</a>. The <a class="idlType" href="#widl-IDBErrorEvent-message"><code>message</code></a> is
              set to a string appropriate for <var>code</var>.
            <li>
              Set the <a>active</a> flag of <var>transaction</var> to false.
            </li>
          </ol>
          <p class="issue">
            TODO: need to define more error handling here.
          </p>
        </section>
      </section>
      <!-- end-content -->
    </section>
  </body>
</html>
