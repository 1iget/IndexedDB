<!DOCTYPE html>
<html lang='en-US'>
  <head>
    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
    <title>Indexed Database API</title>
    <meta name='revision' content='$Id: Overview.html,v 1.41 2010/03/24 17:58:17 nmehta3 Exp $'/>
    <script src='http://dev.w3.org/2009/dap/ReSpec.js/js/respec.js' class='remove'></script>
    <script src='http://dev.w3.org/2009/dap/ReSpec.js/js/simple-node.js' class='remove'></script>
    <script class='remove'>
      var respecConfig = {
          specStatus:           "ED",

          shortName:            "IndexedDB",

          //publishDate:          "2010-01-05",

          previousPublishDate:  "2011-12-06",
          previousMaturity:     "WD",

          edDraftURI:           "http://dev.w3.org/2006/webapi/WebSimpleDB/",

          // if this is a LCWD, uncomment and set the end of its review period
          // lcEnd: "2009-08-05",

          extraCSS: [
                "http://dev.w3.org/2009/dap/ReSpec.js/css/respec.css",
                "SimpleDB.css"
          ],

          // editors, add as many as you like
          // only "name" is required
          editors:  [
              { name: "Nikunj Mehta", url: "mailto:nikunj@o-micron.com",
                company: "Invited Expert" },
              { name: "Jonas Sicking", url: "mailto:jonas@sicking.cc",
                company: "Mozilla" },
              { name: "Eliot Graff", url: "mailto:eliotgra@microsoft.com",
                company: "Microsoft" },
              { name: "Andrei Popescu", url: "mailto:andreip@google.com",
                company: "Google" }
              { name: "Jeremy Orlow", url: "mailto:jorlow@google.com",
                company: "Google" }
          ],

          maxTocLevel: 3,

          wg:           "Web Applications Working Group",

          wgURI:        "http://www.w3.org/2008/webapps/",

          wgPublicList: "public-webapps",

          wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/42538/status",
      };
    </script>
    <script class="remove">
      function examples() {
        var examples = document.querySelectorAll('div.example');
        sn = new berjon.simpleNode({
                        "":     "http://www.w3.org/1999/xhtml",
                        "x":    "http://www.w3.org/1999/xhtml"
                    });
        for (var i = 0; i < examples.length; i++) {
          var example = examples.item(i);
          var header = sn.element('div', {'class': 'exampleHeader'}, null, 'Example');
          example.insertBefore(header, example.firstChild);
        }
      }

      function codeblocks() {
        document.normalize();
        sn = new berjon.simpleNode({
                        "":     "http://www.w3.org/1999/xhtml",
                        "x":    "http://www.w3.org/1999/xhtml"
                    });

        var blocks = document.querySelectorAll('codeblock');
        for (var i = 0; i < blocks.length; i++) {
          var codeblock = blocks.item(i);
          var div = sn.element('div', {'class': 'block'})
          sn.element('span', {'class': 'blockTitle'},
            sn.element('div', {'class': 'blockTitleDiv'}, div), 'ECMAScript');
          var code = sn.element('code', {'class': 'es-code'},
                       sn.element('pre', {'class': 'code'},
                         sn.element('div', {'class': 'blockContent'}, div)));
          sn.copyChildren(codeblock, code);
          codeblock.parentNode.replaceChild(div, codeblock);
        }
      }
      window.onload = function() {
        examples();
        codeblocks();
        (new berjon.respec()).loadAndRun();
      }
    </script>
    <!--[if IE]>
    <style type='text/css'>
      .ignore {
        -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";
        filter: alpha(opacity=50);
      }
    </style>
    <![endif]-->
    <style type="text/css">
      table {
        border-collapse: collapse;
        border-style: hidden hidden none;
      }
      table thead {
        border-bottom: medium solid;
      }
      table td, table th {
        border-bottom: thin solid;
        border-left: medium solid;
        border-right: medium solid;
        padding: 0.2em;
        vertical-align: top;
      }
      h5 {
        display: none
      }
    </style>
  </head>

  <body>
    <section id="abstract">
      <p>
        This document defines APIs for a database of records holding simple values
        and hierarchical objects. Each record consists of a key and some value.
        Moreover, the database maintains indexes over records it stores. An
        application developer directly uses an API to locate records either by
        their key or by using an index. A query language can be layered on this
        API. An indexed database can be implemented using a persistent B-tree data
        structure.
      </p>
    </section>

    <section id="database-api" class="section">
      <h2>Indexed Database API</h2>
    <!-- begin-content -->
    <section id='introduction' class='section informative'>
      <h2>Introduction</h2>

	
      <p>
        User agents need to store large numbers of objects locally in
        order to satisfy off-line data requirements of Web applications.
        [[WEBSTORAGE]] is useful for
        storing pairs of keys and their corresponding values. However, it does 
        not provide in-order retrieval of keys, efficient searching over
        values, or storage of duplicate values for a key. 
      </p>
      
      <p>
        This specification provides a concrete API to perform advanced key-value data management
        that is at the heart of most sophisticated query processors. It does
        so by using transactional databases to store keys and their 
        corresponding values (one or more per key), and providing a means
        of traversing keys in a deterministic order. This is often implemented
        through the use of persistent B-tree data structures that are considered
        efficient for insertion and deletion as well as in-order traversal of
        very large numbers of data records.
      </p>

      <p class="issue">
        TODO: Add examples using the sync and the async APIs.
      </p>

<!-- We need and example, but until this one is updated, it's doing more harm than good.
      <div class="example">
        <p>
          A script can efficiently find records in an object store that come 
          closest to the required value provided the value is stored in either 
          a primary or a secondary key.
          In the following example, the 'books' object store holds data about
          books which are stored by their 'isbn' attribute. Additionally, 
          an index is maintained on the 'author' attribute of the objects
          stored in the object store. This index can be used to look up books
          for a given author. If an exact match is not found, the operation
          raises an exception.
        </p>
        <codeblock>var db = indexedDB.open('books', 'Book store', false);
if (db.version !== '1.0') {
  var olddb = indexedDB.open('books', 'Book store');
  olddb.createObjectStore('books', 'isbn');
  olddb.createIndex('BookAuthor', 'books', 'author', false);
  olddb.setVersion("1.0");  
}
// db.version === "1.0";  
var index = db.openIndex('BookAuthor');
var matching = index.get('fred');
if (matching)
  report(matching.isbn, matching.name, matching.author);
else
  report(null);</codeblock>
        <p>
        The next example performs the exact same logic as above asynchronously.
        </p>
        <codeblock>
  function findFred() {
    var store = db.objectStore('books');
    var index = store.index('BookAuthor');
    var req = index.get('fred');
    req.onsuccess = function(event) {
      var matching = event.result;
      report(matching.isbn, matching.name, matching.author);
    }
    req.onerror = function(event) {
      report(null);
    }
  }

  var db;
  var dbRequest = indexedDB.open('books', 'Book store');
  dbRequest.onsuccess = function(event) {
    db = event.result;
    if (db.version != "1.0") {
      var versionRequest = db.setVersion("1.0");
      versionRequest.ontimeout = function(event) {
        throw new Error("timeout trying to set version to 1.0");
      }
      versionRequest.onsuccess = function(event) {
        var store = db.createObjectStore('books', 'isbn');
        store.createIndex('BookAuthor', 'books', 'author', false);
        event.transaction.onabort = function(event) {
          throw new Error("error while trying to set version to 1.0");
        }
        event.transaction.oncomplete = function(event) {
          findFred(db);
        }
      }
    } else {
      findFred(db);
    }
  }
   
        </codeblock>
        <p>
        Here is an example of a script using this API. First, a function
        <code>prepareDatabase()</code> is defined. This function tries to create 
        the database if necessary, giving it one object store called "docids" with
        the primary key "id". If it is successful, or if the table
        doesn't need creating, it calls the function that does the
        actual work, in this case <code>showDocCount()</code>.
        </p>
        <codeblock>
var request = null;
function prepareDatabase(ready, error) {
  request = new <a>IDBDatabaseRequest</a>();
  request.<a>onsuccess</a> = ready;
  request.<a>onerror</a> = error;
  var upgrade = 
    function(changes, db) {
      changes.<a>createObjectStore</a>('docids', 'id');
      // now db.<a>version</a> === '1.0'
    };
  request.<a>open</a>('documents', '1.0', 'Offline document storage', upgrade);
}

function showDocCount(db, span) {
  var storeRequest = new <a>IDBObjectStoreRequest</a>(db);
  storeRequest.<a>onsuccess</a> = 
    function() {
      var store = storeRequest.<a>store</a>, total = 0;
      var cursorRequest = new <a>IDBCursorRequest</a>(store);
      cursorRequest.<a>onsuccess</a> = 
        function() {
          span.textContent = total;
        };
      cursorRequest.<a>open</a>(function(record, cursor) { 
          total += cursor.<a>count</a>; 
        }, <a>IDBCursor</a>.<a>NEXT_NO_DUPLICATE</a>);
    };
  storeRequest.<a>open</a>('docids', true);
};

prepareDatabase(function(evt) {
  // got database
  var span = document.getElementById('doc-count');
  showDocCount(request.<a>database</a>, span);
  }, function (evt) {
  // error getting database
  var error = request.error;
  alert(error.message);
});</codeblock>
      </div>-->
    </section>

    <section id='conformance' class='section'>
      <p>
        This specification defines one class of products:
      </p>
      <dl>
        <dt><dfn id='dfn-conforming-user-agent'>Conforming user agent</dfn></dt>
        <dd>
          <p>
            A user agent MUST behave as described in this specification
            in order to be considered conformant.
          </p>
          
          <p>
            User agents MAY implement algorithms given in this
            specification in any way desired, so long as the end result is
            indistinguishable from the result that would be obtained by the
            specification's algorithms.
          </p>
          
          <p>
            A conforming Indexed Database API user agent MUST also be a
            <em>conforming implementation</em> of the IDL fragments
            of this specification, as described in the
            “Web IDL” specification. [[!WEBIDL]]
          </p>
          
          <div class="note">
            This specification uses both the terms "conforming user agent(s)" 
            and "user agent(s)" to refer to this product class.
          </div>
        </dd>
      </dl>        
      
      <section class="section" id="dependencies">
        <h3>Dependencies</h3>
        <p>
          This specification relies on several other underlying specifications. 
        </p>
        <dl>
          <dt>DOM-LEVEL-3-EVENTS</dt>
          <dd>The terms <dfn>default action</dfn> and <dfn>propagation path</dfn> are defined by the
            Document Object Model (DOM) Level 3 Events Specification [[!DOM-LEVEL-3-EVENTS]].
          </dd>
          <dt>HTML5</dt>
          <dd>The terms and algorithms <dfn id="document-base-url">document base URL</dfn>,
            <dfn id="event-handler-attributes">event handler attributes</dfn>, 
            <dfn id="event-handler-event-type">event handler event type</dfn>,
            <dfn title="Function"><code>Function</code></dfn>,
            <dfn>origin</dfn>, <dfn>same origin</dfn>, <dfn>structured clone</dfn>,
            <dfn>structured clone algorithm</dfn>, <dfn>task</dfn>, <dfn>task source</dfn>, 
            and <dfn title="queue-a-task">queue a task</dfn> are defined by the HTML 5 
            specification [[!HTML5]].
          </dd>
          <dt>WebIDL</dt>
          <dd>Many of the interface definitions and all of the IDL in this spec depends on [[!WEBIDL]].</dd>
          <dt>WebWorkers</dt>
          <dd>The term <dfn title="Worker"><a class="externalDFN"><code>Worker</code></a></dfn> is defined by
          the WebWorkers specification [[!WEBWORKERS]].</dd>
        </dl>
      </section>
    </section>
    <!-- end-content -->
    </section>
  </body>
</html>
